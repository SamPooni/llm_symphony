<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mixture of Experts (MoE) - Architecture & Routing</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; min-height: 100vh; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;

    function MoEArchitecture() {
      const [tooltip, setTooltip] = useState(null);
      const [mousePos, setMousePos] = useState({ x: 0, y: 0 });

      const handleMouseMove = (e) => {
        const target = e.target.closest('[data-tooltip-id]');
        if (target) {
          setTooltip(target.getAttribute('data-tooltip-id'));
        } else {
          setTooltip(null);
        }
        setMousePos({ x: e.clientX, y: e.clientY });
      };

      const showTooltip = (id) => setTooltip(id);
      const hideTooltip = () => setTooltip(null);

      const tooltips = {
        // Core Concept
        'moe-concept': {
          title: 'üîÄ MIXTURE OF EXPERTS (MoE)',
          content: 'Replace dense FFN with multiple "expert" FFNs. Router selects which experts process each token.',
          insight: 'More parameters without proportional compute increase. Each token only uses a subset of total params.',
          benefit: '8√ó more params, ~2√ó more compute\nBetter performance per FLOP\nUsed by GPT-4, Mixtral, DeepSeek'
        },
        'moe-dense-vs-sparse': {
          title: 'üìä DENSE VS SPARSE',
          content: 'Dense: Every param used for every token. Sparse MoE: Only selected experts used.',
          comparison: 'Dense 70B: 70B active params\nMoE 8√ó7B: 47B total, 12B active\nSame compute, more capacity!',
          tradeoff: 'Dense: Simpler, no routing\nMoE: More capacity, routing overhead'
        },
        'moe-why': {
          title: '‚ùì WHY MoE?',
          content: 'Scaling laws suggest more params help, but compute is expensive. MoE breaks the link.',
          benefits: '1. More parameters (capacity)\n2. Same compute (efficiency)\n3. Specialization (experts learn domains)\n4. Better scaling',
          examples: 'GPT-4: Rumored 8√ó experts\nMixtral 8x7B: 8 experts\nDeepSeek MoE: 64 experts'
        },

        // Router
        'router-concept': {
          title: 'üéØ ROUTER / GATING NETWORK',
          content: 'Small network that decides which experts process each token. The brain of MoE.',
          mechanism: 'Input: token hidden state\nOutput: probability over experts\nSelect top-k experts',
          formula: 'g(x) = softmax(W_g √ó x)\nroute = top_k(g(x))'
        },
        'router-topk': {
          title: 'üîù TOP-K ROUTING',
          content: 'Select k experts per token. Typically k=1 or k=2.',
          mechanism: 'k=1: Single expert (simpler)\nk=2: Two experts combined\nWeighted sum of outputs',
          formula: 'output = Œ£ g_i(x) √ó Expert_i(x)\nOnly sum over selected k experts'
        },
        'router-softmax': {
          title: 'üìä Router Softmax',
          content: 'Convert router logits to probabilities. Determines expert weights.',
          formula: 'g(x) = softmax(W_g √ó x + noise)\nNoise during training helps exploration',
          output: 'Probabilities sum to 1\nHigher prob = more influence\nUsed to weight expert outputs'
        },
        'router-noise': {
          title: 'üé≤ Router Noise',
          content: 'Add noise during training to encourage exploration of all experts.',
          mechanism: 'noise = softplus(W_noise √ó x) √ó N(0,1)\nlogits = W_g √ó x + noise',
          why: 'Without noise: Collapse to few experts\nWith noise: Explore all experts\nOnly during training'
        },

        // Experts
        'expert-structure': {
          title: 'üß† EXPERT STRUCTURE',
          content: 'Each expert is a standard FFN (MLP). Same architecture, different weights.',
          structure: 'Expert = FFN:\n  up_proj: [d, 4d]\n  gate_proj: [d, 4d] (if SwiGLU)\n  down_proj: [4d, d]',
          params: 'Mixtral 8x7B:\n8 experts √ó 7B params each\nShared attention, expert FFN'
        },
        'expert-specialization': {
          title: 'üéì EXPERT SPECIALIZATION',
          content: 'Experts naturally learn different domains/skills. Emergent specialization.',
          examples: 'Expert 1: Code/math\nExpert 2: Languages\nExpert 3: Reasoning\nExpert 4: Facts',
          emergence: 'Not explicitly trained\nEmerges from routing\nAnalyzable post-hoc'
        },
        'expert-ffn': {
          title: 'üîß Expert FFN',
          content: 'Standard SwiGLU or GELU FFN. Same as dense model FFN.',
          swiglu: 'gate = sigmoid(W_gate √ó x)\nup = W_up √ó x\nhidden = gate ‚äô up\noutput = W_down √ó hidden',
          size: 'Typical: 4√ó hidden dim\nMixtral: 14336 intermediate\nSame as dense 7B'
        },

        // Load Balancing
        'balance-problem': {
          title: '‚ö†Ô∏è LOAD IMBALANCE PROBLEM',
          content: 'Some experts may be chosen much more than others. Wastes capacity.',
          symptoms: 'Popular experts overloaded\nUnpopular experts unused\nReduced effective capacity',
          extreme: 'Collapse: All tokens ‚Üí 1 expert\nModel becomes dense\nMust prevent!'
        },
        'balance-aux-loss': {
          title: 'üìä AUXILIARY LOSS',
          content: 'Extra loss term to encourage balanced expert usage.',
          formula: 'L_aux = Œ± √ó Œ£ f_i √ó P_i\nf_i = fraction of tokens to expert i\nP_i = avg probability for expert i',
          effect: 'Penalizes imbalanced routing\nŒ± typically 0.01-0.1\nAdded to main loss'
        },
        'balance-capacity': {
          title: 'üì¶ CAPACITY FACTOR',
          content: 'Maximum tokens each expert can process. Overflow tokens dropped.',
          formula: 'capacity = (tokens / experts) √ó capacity_factor\nTypical CF = 1.25-2.0',
          mechanism: 'Expert buffer fills up\nExtra tokens dropped or rerouted\nEnsures balance'
        },
        'balance-zeroshot': {
          title: 'üéØ Z-Loss / Router Z-Loss',
          content: 'Penalize large router logits to prevent one expert dominating.',
          formula: 'L_z = (1/n) √ó Œ£ log¬≤(Œ£exp(logits))\nKeeps logits small\nPrevents overconfident routing'
        },

        // Compute
        'compute-active': {
          title: '‚ö° ACTIVE PARAMETERS',
          content: 'Parameters actually used per token. Much less than total for MoE.',
          example: 'Mixtral 8x7B:\nTotal: 46.7B params\nActive: ~12.9B per token\nEfficiency: 3.6√ó more capacity',
          formula: 'Active = shared + (k √ó expert_params)\nShared = embedding + attention'
        },
        'compute-flops': {
          title: 'üî¢ FLOP ANALYSIS',
          content: 'Compute scales with active params, not total params.',
          comparison: 'Dense 70B: 2 √ó 70B FLOPs/token\nMoE 8√ó7B: 2 √ó 12.9B FLOPs/token\n~5.4√ó less compute!',
          caveat: 'Routing overhead small (~0.1%)\nCommunication overhead (expert parallel)\nNot quite as efficient in practice'
        },
        'compute-memory': {
          title: 'üíæ MEMORY FOOTPRINT',
          content: 'Must store ALL expert weights, even though only k used per token.',
          breakdown: 'Total memory = all expert params\nMixtral: 46.7B √ó 2 bytes = 93GB\nCannot reduce via sparsity',
          implication: 'Memory scales with total params\nCompute scales with active params\nMemory is the bottleneck'
        },

        // Expert Parallelism
        'ep-concept': {
          title: 'üîÑ EXPERT PARALLELISM (EP)',
          content: 'Distribute experts across GPUs. Each GPU holds subset of experts.',
          mechanism: 'GPU 1: Experts 0-1\nGPU 2: Experts 2-3\n...\nRoute tokens to correct GPU',
          communication: 'All-to-all communication\nSend tokens to expert GPUs\nReceive results back'
        },
        'ep-all2all': {
          title: 'üì° ALL-TO-ALL',
          content: 'Communication pattern for expert parallelism. Every GPU sends to every other.',
          mechanism: '1. Each GPU has some tokens\n2. Route decisions made\n3. All-to-all: send tokens\n4. Process at expert GPU\n5. All-to-all: return results',
          cost: 'High communication volume\nCan be bandwidth bottleneck\nNeed fast interconnect'
        },
        'ep-combine': {
          title: 'üîó COMBINING WITH TP/DP',
          content: 'Expert parallel combines with tensor parallel and data parallel.',
          typical: 'Within node: TP for attention\nAcross nodes: EP for experts\nGlobal: DP for scaling',
          example: '64 GPUs:\nTP=8 (within node)\nEP=8 (across nodes)\nEffective batch: 64√ó larger'
        },

        // Models
        'model-mixtral': {
          title: 'üî∑ MIXTRAL 8x7B',
          content: 'Mistral\'s MoE model. 8 experts, 2 active. Very efficient.',
          specs: 'Experts: 8\nActive: 2 (top-2 routing)\nTotal params: 46.7B\nActive params: 12.9B',
          performance: 'Matches LLaMA-2 70B quality\n~5√ó faster inference\nOpen weights'
        },
        'model-deepseek': {
          title: 'üî∑ DeepSeek MoE',
          content: 'More granular experts. 64 experts, 6 active. Fine-grained routing.',
          specs: 'Experts: 64 (fine-grained)\nActive: 6\nShared experts: 2 always-on\nBetter specialization',
          innovation: 'Shared + routed experts\nMore experts, fewer active\nBetter utilization'
        },
        'model-gpt4': {
          title: 'üî∑ GPT-4 (Rumored)',
          content: 'Rumored to be 8√ó ~200B MoE. Not officially confirmed.',
          rumored: 'Experts: 8\nPer expert: ~200B\nTotal: ~1.7T params\nActive: ~200B',
          caveat: 'NOT CONFIRMED\nBased on leaks/rumors\nArchitecture unknown'
        },

        // Implementation
        'impl-megablocks': {
          title: 'üß± Megablocks',
          content: 'Efficient MoE implementation. Block-sparse operations.',
          approach: 'Group tokens by expert\nBatched expert computation\nAvoidspadding waste',
          benefit: 'Much faster than naive\nGood GPU utilization\nUsed in practice'
        },
        'impl-dropless': {
          title: 'üéØ Dropless MoE',
          content: 'Avoid dropping tokens by dynamic capacity allocation.',
          mechanism: 'Don\'t fix capacity per expert\nProcess all routed tokens\nReorder and batch efficiently',
          benefit: 'No information loss\nBetter quality\nSlightly more complex'
        },

        // Challenges
        'challenge-training': {
          title: '‚ö†Ô∏è TRAINING CHALLENGES',
          content: 'MoE training is trickier than dense models.',
          issues: 'Load imbalance\nExpert collapse\nRouting instability\nHigher memory\nCommunication overhead',
          solutions: 'Aux losses\nCapacity factors\nCareful hypertuning\nExpert parallelism'
        },
        'challenge-inference': {
          title: '‚ö†Ô∏è INFERENCE CHALLENGES',
          content: 'MoE inference has unique challenges.',
          issues: 'All experts in memory\nVariable compute per token\nBatching complexity\nExpert locality',
          solutions: 'Expert offloading\nSpeculative expert loading\nBatch by expert pattern'
        },
      };

      const Tooltip = () => {
        if (!tooltip || !tooltips[tooltip]) return null;
        const t = tooltips[tooltip];
        
        let left = mousePos.x + 15;
        let top = mousePos.y + 15;
        if (left + 420 > window.innerWidth) left = mousePos.x - 420;
        if (top + 350 > window.innerHeight) top = window.innerHeight - 360;
        
        return (
          <div 
            className="fixed z-50 w-[400px] p-5 bg-slate-900 border-2 border-white/20 rounded-xl shadow-2xl"
            style={{ left, top }}
          >
            <div className="text-lg font-black text-white mb-2">{t.title}</div>
            <p className="text-slate-300 text-sm leading-relaxed mb-3">{t.content}</p>
            {t.formula && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">FORMULA</div>
                <pre className="text-xs text-cyan-300 font-mono whitespace-pre-wrap">{t.formula}</pre>
              </div>
            )}
            {t.mechanism && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">MECHANISM</div>
                <pre className="text-xs text-green-300 font-mono whitespace-pre-wrap">{t.mechanism}</pre>
              </div>
            )}
            {t.specs && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">SPECIFICATIONS</div>
                <pre className="text-xs text-purple-300 font-mono whitespace-pre-wrap">{t.specs}</pre>
              </div>
            )}
            {t.comparison && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">COMPARISON</div>
                <pre className="text-xs text-yellow-300 font-mono whitespace-pre-wrap">{t.comparison}</pre>
              </div>
            )}
            {t.example && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">EXAMPLE</div>
                <pre className="text-xs text-orange-300 font-mono whitespace-pre-wrap">{t.example}</pre>
              </div>
            )}
            {t.benefit && (
              <div className="text-xs text-green-400">
                <span className="font-bold">‚úÖ </span>{t.benefit}
              </div>
            )}
            {t.insight && (
              <div className="text-xs text-blue-400 mt-2">
                <span className="font-bold">üí° </span>{t.insight}
              </div>
            )}
          </div>
        );
      };

      const Hoverable = ({ id, children }) => (
        <div 
          data-tooltip-id={id}
          className="cursor-pointer transition-all hover:scale-[1.02] hover:brightness-110"
        >
          {children}
        </div>
      );

      return (
        <div className="min-h-screen bg-black text-white p-8" onMouseMove={handleMouseMove}>
          <Tooltip />
          
          {/* Background */}
          <div className="fixed inset-0 pointer-events-none overflow-hidden">
            <div className="absolute w-[800px] h-[800px] -top-96 left-1/4 bg-orange-500/10 rounded-full blur-3xl" />
            <div className="absolute w-[600px] h-[600px] top-1/2 right-0 bg-amber-500/10 rounded-full blur-3xl" />
            <div className="absolute w-[600px] h-[600px] bottom-0 left-0 bg-yellow-500/10 rounded-full blur-3xl" />
          </div>

          <div className="relative max-w-7xl mx-auto">
            {/* Header */}
            <header className="text-center mb-12">
              <div className="inline-flex items-center gap-2 px-6 py-2 bg-orange-600/30 border border-orange-400 rounded-full mb-6">
                <span className="text-orange-300 font-bold">MIXTURE OF EXPERTS</span>
                <span className="text-white">‚Ä¢</span>
                <span className="text-orange-200 font-medium">Hover for details</span>
              </div>
              <h1 className="text-5xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-orange-400 via-amber-400 to-yellow-400">
                MoE Architecture
              </h1>
              <p className="text-xl text-slate-200 max-w-3xl mx-auto leading-relaxed">
                <span className="text-orange-300 font-bold">More parameters, same compute</span> ‚Äî sparse expert routing for efficient scaling.
              </p>
            </header>

            {/* Key Insight */}
            <Hoverable id="moe-concept">
              <div className="bg-gradient-to-r from-orange-900/50 to-amber-900/50 border-2 border-orange-500/50 rounded-xl p-8 mb-12">
                <div className="text-center">
                  <div className="text-2xl font-black text-white mb-4">üîÄ THE MoE INSIGHT</div>
                  <div className="inline-block bg-black/50 rounded-xl p-6 font-mono text-xl text-orange-300 border border-orange-500/50">
                    More Parameters ‚â† More Compute
                  </div>
                  <div className="mt-4 text-slate-300">
                    Route each token to only <span className="text-amber-400 font-bold">k experts</span> out of <span className="text-orange-400 font-bold">N total</span>
                  </div>
                </div>
              </div>
            </Hoverable>

            {/* SECTION 1: CORE CONCEPT */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-orange-500/50">
                  1
                </div>
                <div>
                  <h2 className="text-3xl font-black text-orange-300">CORE CONCEPT</h2>
                  <p className="text-orange-200/80">Dense vs Sparse, why MoE works</p>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-6 mb-6">
                <Hoverable id="moe-dense-vs-sparse">
                  <div className="bg-slate-900/80 border border-orange-500/30 rounded-xl p-5">
                    <div className="text-lg font-black text-orange-300 mb-4">Dense vs Sparse</div>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-slate-800 rounded-lg p-4 text-center">
                        <div className="text-3xl mb-2">üî∑</div>
                        <div className="text-slate-200 font-bold">Dense 70B</div>
                        <div className="text-slate-400 text-sm">70B active</div>
                        <div className="text-red-400 text-xs mt-2">All params used</div>
                      </div>
                      <div className="bg-orange-900/30 border border-orange-400 rounded-lg p-4 text-center">
                        <div className="text-3xl mb-2">üîÄ</div>
                        <div className="text-orange-200 font-bold">MoE 8√ó7B</div>
                        <div className="text-orange-300 text-sm">12B active</div>
                        <div className="text-green-400 text-xs mt-2">Only k experts</div>
                      </div>
                    </div>
                  </div>
                </Hoverable>

                <Hoverable id="moe-why">
                  <div className="bg-slate-900/80 border border-amber-500/30 rounded-xl p-5">
                    <div className="text-lg font-black text-amber-300 mb-4">Why MoE?</div>
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <span className="text-green-400">‚úì</span>
                        <span className="text-slate-300">More parameters (capacity)</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-green-400">‚úì</span>
                        <span className="text-slate-300">Same compute (efficiency)</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-green-400">‚úì</span>
                        <span className="text-slate-300">Expert specialization</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-green-400">‚úì</span>
                        <span className="text-slate-300">Better scaling laws</span>
                      </div>
                    </div>
                  </div>
                </Hoverable>
              </div>

              {/* MoE Architecture Visual */}
              <div className="bg-slate-900/80 border border-orange-500/30 rounded-xl p-6">
                <div className="text-lg font-black text-orange-300 mb-4 text-center">üèóÔ∏è MoE Layer Architecture</div>
                <div className="flex items-center justify-center gap-4">
                  <div className="bg-blue-900/50 border border-blue-400 rounded-xl p-4 text-center">
                    <div className="text-blue-200 font-bold">Input</div>
                    <div className="text-blue-100/60 text-xs">Hidden state x</div>
                  </div>
                  
                  <div className="text-orange-400 text-2xl">‚Üí</div>
                  
                  <Hoverable id="router-concept">
                    <div className="bg-purple-900/50 border-2 border-purple-400 rounded-xl p-4 text-center">
                      <div className="text-2xl mb-1">üéØ</div>
                      <div className="text-purple-200 font-bold">Router</div>
                      <div className="text-purple-100/60 text-xs">g(x) = softmax(Wx)</div>
                      <div className="text-purple-300 text-xs mt-1">Select top-k</div>
                    </div>
                  </Hoverable>
                  
                  <div className="text-orange-400 text-2xl">‚Üí</div>
                  
                  {/* Experts */}
                  <div className="flex flex-col gap-2">
                    {[0,1,2,3,4,5,6,7].map(i => (
                      <Hoverable key={i} id="expert-structure">
                        <div className={`w-16 h-6 rounded ${i < 2 ? 'bg-orange-500 border border-orange-300' : 'bg-slate-700'} flex items-center justify-center text-xs font-bold ${i < 2 ? 'text-white' : 'text-slate-500'}`}>
                          E{i}
                        </div>
                      </Hoverable>
                    ))}
                    <div className="text-center text-slate-500 text-xs mt-1">k=2 active</div>
                  </div>
                  
                  <div className="text-orange-400 text-2xl">‚Üí</div>
                  
                  <div className="bg-green-900/50 border border-green-400 rounded-xl p-4 text-center">
                    <div className="text-green-200 font-bold">Combine</div>
                    <div className="text-green-100/60 text-xs">Œ£ g·µ¢ √ó Expert·µ¢(x)</div>
                  </div>
                  
                  <div className="text-orange-400 text-2xl">‚Üí</div>
                  
                  <div className="bg-blue-900/50 border border-blue-400 rounded-xl p-4 text-center">
                    <div className="text-blue-200 font-bold">Output</div>
                    <div className="text-blue-100/60 text-xs">Back to main path</div>
                  </div>
                </div>
              </div>
            </section>

            {/* SECTION 2: ROUTING */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-purple-500/50">
                  2
                </div>
                <div>
                  <h2 className="text-3xl font-black text-purple-300">ROUTING MECHANISM</h2>
                  <p className="text-purple-200/80">How tokens find their experts</p>
                </div>
              </div>

              <div className="grid grid-cols-4 gap-4">
                <Hoverable id="router-topk">
                  <div className="p-4 rounded-xl bg-purple-900/50 border-2 border-purple-400">
                    <div className="text-xl font-black text-purple-200 mb-2">üîù Top-K</div>
                    <div className="text-purple-100/80 text-sm">Select k experts</div>
                    <div className="text-purple-100/60 text-xs mt-2">k=1 or k=2 typical</div>
                  </div>
                </Hoverable>

                <Hoverable id="router-softmax">
                  <div className="p-4 rounded-xl bg-violet-900/50 border-2 border-violet-400">
                    <div className="text-xl font-black text-violet-200 mb-2">üìä Softmax</div>
                    <div className="text-violet-100/80 text-sm">Probability weights</div>
                    <div className="text-violet-100/60 text-xs mt-2">Sum to 1</div>
                  </div>
                </Hoverable>

                <Hoverable id="router-noise">
                  <div className="p-4 rounded-xl bg-indigo-900/50 border-2 border-indigo-400">
                    <div className="text-xl font-black text-indigo-200 mb-2">üé≤ Noise</div>
                    <div className="text-indigo-100/80 text-sm">Exploration (training)</div>
                    <div className="text-indigo-100/60 text-xs mt-2">Prevent collapse</div>
                  </div>
                </Hoverable>

                <Hoverable id="expert-specialization">
                  <div className="p-4 rounded-xl bg-blue-900/50 border-2 border-blue-400">
                    <div className="text-xl font-black text-blue-200 mb-2">üéì Specialization</div>
                    <div className="text-blue-100/80 text-sm">Emergent domains</div>
                    <div className="text-blue-100/60 text-xs mt-2">Code, lang, math</div>
                  </div>
                </Hoverable>
                
                <Hoverable id="expert-ffn">
                  <div className="p-4 rounded-xl bg-violet-900/50 border-2 border-violet-400">
                    <div className="text-xl font-black text-violet-200 mb-2">üîß Expert FFN</div>
                    <div className="text-violet-100/80 text-sm">SwiGLU structure</div>
                    <div className="text-violet-100/60 text-xs mt-2">Same as dense FFN</div>
                  </div>
                </Hoverable>
              </div>
            </section>

            {/* SECTION 3: LOAD BALANCING */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-red-500 to-rose-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-red-500/50">
                  3
                </div>
                <div>
                  <h2 className="text-3xl font-black text-red-300">LOAD BALANCING</h2>
                  <p className="text-red-200/80">Keeping all experts utilized</p>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-6">
                <Hoverable id="balance-problem">
                  <div className="bg-red-900/30 border border-red-500 rounded-xl p-5">
                    <div className="text-lg font-black text-red-300 mb-3">‚ö†Ô∏è The Problem</div>
                    <div className="text-red-100/70 text-sm">Without balancing, routing collapses to few experts:</div>
                    <div className="mt-3 flex gap-2">
                      {[90, 5, 2, 1, 1, 0.5, 0.3, 0.2].map((v, i) => (
                        <div key={i} className="flex-1 text-center">
                          <div 
                            className={`mx-auto rounded ${i === 0 ? 'bg-red-500' : 'bg-slate-700'}`}
                            style={{height: `${Math.max(v * 0.8, 4)}px`, width: '100%'}}
                          />
                          <div className="text-xs text-slate-500 mt-1">E{i}</div>
                        </div>
                      ))}
                    </div>
                    <div className="text-red-400 text-xs mt-2 text-center">Unbalanced: Expert 0 overloaded!</div>
                  </div>
                </Hoverable>

                <div className="space-y-3">
                  <Hoverable id="balance-aux-loss">
                    <div className="bg-green-900/30 border border-green-500 rounded-xl p-4">
                      <div className="text-green-200 font-bold">üìä Auxiliary Loss</div>
                      <div className="text-green-100/60 text-sm">L_aux penalizes imbalance</div>
                    </div>
                  </Hoverable>
                  <Hoverable id="balance-capacity">
                    <div className="bg-emerald-900/30 border border-emerald-500 rounded-xl p-4">
                      <div className="text-emerald-200 font-bold">üì¶ Capacity Factor</div>
                      <div className="text-emerald-100/60 text-sm">Max tokens per expert</div>
                    </div>
                  </Hoverable>
                  <Hoverable id="balance-zeroshot">
                    <div className="bg-teal-900/30 border border-teal-500 rounded-xl p-4">
                      <div className="text-teal-200 font-bold">üéØ Z-Loss</div>
                      <div className="text-teal-100/60 text-sm">Prevent dominant routing</div>
                    </div>
                  </Hoverable>
                </div>
              </div>
            </section>

            {/* SECTION 4: COMPUTE */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-cyan-500/50">
                  4
                </div>
                <div>
                  <h2 className="text-3xl font-black text-cyan-300">COMPUTE & MEMORY</h2>
                  <p className="text-cyan-200/80">Active params vs total params</p>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <Hoverable id="compute-active">
                  <div className="p-4 rounded-xl bg-cyan-900/50 border-2 border-cyan-400">
                    <div className="text-xl font-black text-cyan-200 mb-2">‚ö° Active Params</div>
                    <div className="text-cyan-100/80 text-sm">Per-token compute</div>
                    <div className="text-cyan-300 text-xs mt-2">Mixtral: 12.9B active</div>
                  </div>
                </Hoverable>

                <Hoverable id="compute-flops">
                  <div className="p-4 rounded-xl bg-blue-900/50 border-2 border-blue-400">
                    <div className="text-xl font-black text-blue-200 mb-2">üî¢ FLOPs</div>
                    <div className="text-blue-100/80 text-sm">~5√ó less than dense</div>
                    <div className="text-blue-300 text-xs mt-2">Scales with active</div>
                  </div>
                </Hoverable>

                <Hoverable id="compute-memory">
                  <div className="p-4 rounded-xl bg-indigo-900/50 border-2 border-indigo-400">
                    <div className="text-xl font-black text-indigo-200 mb-2">üíæ Memory</div>
                    <div className="text-indigo-100/80 text-sm">ALL experts stored</div>
                    <div className="text-indigo-300 text-xs mt-2">Mixtral: 93GB weights</div>
                  </div>
                </Hoverable>
              </div>
            </section>

            {/* SECTION 5: EXPERT PARALLELISM */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-green-500/50">
                  5
                </div>
                <div>
                  <h2 className="text-3xl font-black text-green-300">EXPERT PARALLELISM</h2>
                  <p className="text-green-200/80">Distributing experts across GPUs</p>
                </div>
              </div>
              
              <Hoverable id="ep-concept">
                <div className="bg-green-900/30 border border-green-500/50 rounded-lg p-4 mb-6">
                  <div className="text-green-200 font-bold text-center">üîÑ Expert Parallelism (EP)</div>
                  <div className="text-green-100/60 text-sm text-center mt-1">Distribute experts across GPUs ‚Äî each GPU holds subset of experts</div>
                </div>
              </Hoverable>

              <div className="bg-slate-900/80 border border-green-500/30 rounded-xl p-6 mb-6">
                <div className="text-lg font-black text-green-300 mb-4 text-center">üîÑ Expert Parallel Communication</div>
                <div className="flex items-center justify-center gap-4">
                  <div className="bg-blue-900/50 border border-blue-400 rounded-lg p-3 text-center">
                    <div className="text-blue-200 font-bold text-sm">GPU 0</div>
                    <div className="text-blue-100/60 text-xs">E0, E1</div>
                  </div>
                  <div className="bg-cyan-900/50 border border-cyan-400 rounded-lg p-3 text-center">
                    <div className="text-cyan-200 font-bold text-sm">GPU 1</div>
                    <div className="text-cyan-100/60 text-xs">E2, E3</div>
                  </div>
                  
                  <Hoverable id="ep-all2all">
                    <div className="bg-green-900/50 border-2 border-green-400 rounded-xl p-4 text-center mx-4">
                      <div className="text-2xl mb-1">üì°</div>
                      <div className="text-green-200 font-bold">All-to-All</div>
                      <div className="text-green-100/60 text-xs">Route tokens</div>
                    </div>
                  </Hoverable>
                  
                  <div className="bg-purple-900/50 border border-purple-400 rounded-lg p-3 text-center">
                    <div className="text-purple-200 font-bold text-sm">GPU 2</div>
                    <div className="text-purple-100/60 text-xs">E4, E5</div>
                  </div>
                  <div className="bg-pink-900/50 border border-pink-400 rounded-lg p-3 text-center">
                    <div className="text-pink-200 font-bold text-sm">GPU 3</div>
                    <div className="text-pink-100/60 text-xs">E6, E7</div>
                  </div>
                </div>
              </div>

              <Hoverable id="ep-combine">
                <div className="bg-slate-800 border border-slate-600 rounded-xl p-4 text-center">
                  <div className="text-slate-200 font-bold">Combined with TP + DP</div>
                  <div className="text-slate-400 text-sm">TP for attention (within node) ‚Ä¢ EP for experts (across nodes) ‚Ä¢ DP for scaling</div>
                </div>
              </Hoverable>
            </section>

            {/* SECTION 6: MODELS */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-pink-500/50">
                  6
                </div>
                <div>
                  <h2 className="text-3xl font-black text-pink-300">MoE MODELS</h2>
                  <p className="text-pink-200/80">Real-world implementations</p>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <Hoverable id="model-mixtral">
                  <div className="p-4 rounded-xl bg-pink-900/50 border-2 border-pink-400">
                    <div className="text-xl font-black text-pink-200 mb-2">üî∑ Mixtral 8x7B</div>
                    <div className="text-pink-100/80 text-sm">8 experts, k=2</div>
                    <div className="text-pink-100/60 text-xs mt-2">46.7B total, 12.9B active</div>
                    <div className="text-green-400 text-xs mt-1">Open weights ‚úì</div>
                  </div>
                </Hoverable>

                <Hoverable id="model-deepseek">
                  <div className="p-4 rounded-xl bg-rose-900/50 border-2 border-rose-400">
                    <div className="text-xl font-black text-rose-200 mb-2">üî∑ DeepSeek MoE</div>
                    <div className="text-rose-100/80 text-sm">64 experts, k=6</div>
                    <div className="text-rose-100/60 text-xs mt-2">Fine-grained + shared</div>
                    <div className="text-green-400 text-xs mt-1">Open weights ‚úì</div>
                  </div>
                </Hoverable>

                <Hoverable id="model-gpt4">
                  <div className="p-4 rounded-xl bg-slate-800 border border-slate-600">
                    <div className="text-xl font-black text-slate-300 mb-2">üî∑ GPT-4 (Rumored)</div>
                    <div className="text-slate-400 text-sm">8√ó ~200B experts</div>
                    <div className="text-slate-500 text-xs mt-2">~1.7T total (unconfirmed)</div>
                    <div className="text-slate-600 text-xs mt-1">Closed</div>
                  </div>
                </Hoverable>
              </div>
            </section>
            
            {/* SECTION 7: IMPLEMENTATION */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-yellow-500 to-amber-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-yellow-500/50">
                  7
                </div>
                <div>
                  <h2 className="text-3xl font-black text-yellow-300">IMPLEMENTATION & CHALLENGES</h2>
                  <p className="text-yellow-200/80">Efficient MoE training and inference</p>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4 mb-4">
                <Hoverable id="impl-megablocks">
                  <div className="p-4 rounded-xl bg-yellow-900/50 border-2 border-yellow-400">
                    <div className="text-xl font-black text-yellow-200 mb-2">üß± Megablocks</div>
                    <div className="text-yellow-100/80 text-sm">Block-sparse operations</div>
                    <div className="text-yellow-100/60 text-xs mt-2">Efficient GPU batching</div>
                  </div>
                </Hoverable>
                
                <Hoverable id="impl-dropless">
                  <div className="p-4 rounded-xl bg-amber-900/50 border-2 border-amber-400">
                    <div className="text-xl font-black text-amber-200 mb-2">üéØ Dropless MoE</div>
                    <div className="text-amber-100/80 text-sm">No token dropping</div>
                    <div className="text-amber-100/60 text-xs mt-2">Dynamic capacity</div>
                  </div>
                </Hoverable>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <Hoverable id="challenge-training">
                  <div className="p-4 rounded-xl bg-red-900/30 border border-red-500/50">
                    <div className="text-red-200 font-bold">‚ö†Ô∏è Training Challenges</div>
                    <div className="text-red-100/60 text-sm mt-1">Load imbalance ‚Ä¢ Expert collapse ‚Ä¢ High memory</div>
                  </div>
                </Hoverable>
                
                <Hoverable id="challenge-inference">
                  <div className="p-4 rounded-xl bg-orange-900/30 border border-orange-500/50">
                    <div className="text-orange-200 font-bold">‚ö†Ô∏è Inference Challenges</div>
                    <div className="text-orange-100/60 text-sm mt-1">All experts in memory ‚Ä¢ Variable compute ‚Ä¢ Batching</div>
                  </div>
                </Hoverable>
              </div>
            </section>

            {/* Summary */}
            <div className="bg-gradient-to-r from-orange-900/50 to-amber-900/50 border-2 border-orange-400/50 rounded-xl p-8 text-center">
              <div className="text-2xl font-black text-white mb-4">
                üîÄ MoE SUMMARY
              </div>
              <div className="text-slate-300 max-w-3xl mx-auto mb-6">
                MoE enables massive parameter counts with manageable compute costs.
                Router selects experts, load balancing prevents collapse, expert parallelism enables scaling.
              </div>
              
              <div className="grid grid-cols-4 gap-4 mt-6 text-sm">
                <div className="bg-slate-800 rounded-lg p-3">
                  <div className="text-orange-300 font-bold">Mixtral</div>
                  <div className="text-slate-400">8√ó7B, k=2</div>
                </div>
                <div className="bg-slate-800 rounded-lg p-3">
                  <div className="text-purple-300 font-bold">Router</div>
                  <div className="text-slate-400">top-k softmax</div>
                </div>
                <div className="bg-slate-800 rounded-lg p-3">
                  <div className="text-green-300 font-bold">Balance</div>
                  <div className="text-slate-400">aux loss + capacity</div>
                </div>
                <div className="bg-slate-800 rounded-lg p-3">
                  <div className="text-cyan-300 font-bold">Benefit</div>
                  <div className="text-slate-400">~5√ó less compute</div>
                </div>
              </div>
            </div>

            {/* Footer */}
            <footer className="mt-12 text-center text-slate-500 text-sm">
              <p>Mixture of Experts ‚Ä¢ Sparse Routing for Efficient Scaling</p>
              <p className="text-xs mt-1 text-slate-600">More params, same compute, better performance</p>
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MoEArchitecture />);
  </script>
</body>
</html>
