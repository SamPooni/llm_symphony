<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post-Training: SFT, RLHF & DPO - Training Lifecycle</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; min-height: 100vh; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;

    function PostTrainingStage() {
      const [tooltip, setTooltip] = useState(null);
      const [mousePos, setMousePos] = useState({ x: 0, y: 0 });

      const handleMouseMove = (e) => {
        const target = e.target.closest('[data-tooltip-id]');
        if (target) {
          setTooltip(target.getAttribute('data-tooltip-id'));
        } else {
          setTooltip(null);
        }
        setMousePos({ x: e.clientX, y: e.clientY });
      };

      const showTooltip = (id) => setTooltip(id);
      const hideTooltip = () => setTooltip(null);

      const tooltips = {
        // Overview Metrics
        'metric-stages': {
          title: 'üìä POST-TRAINING STAGES',
          content: 'The journey from base model to assistant. Multiple stages refine behavior.',
          stages: '1. SFT: Learn instruction format\n2. RLHF/DPO: Align with preferences\n3. Safety: Red-teaming & guardrails\n4. Capability: Tool use, RAG, etc.',
          timeline: 'SFT: Days to weeks\nRLHF: Weeks\nDPO: Days\nTotal: 1-3 months'
        },
        'metric-data': {
          title: 'üìù DATA REQUIREMENTS',
          content: 'Post-training uses curated, high-quality data. Much smaller than pretraining but more expensive per example.',
          volumes: 'SFT: 10K - 1M examples\nRLHF: 100K+ comparisons\nDPO: 50K+ preference pairs',
          quality: 'Human-written or curated\nCarefully reviewed\n$$ per example (human labor)'
        },
        'metric-compute': {
          title: '‚ö° COMPUTE REQUIREMENTS',
          content: 'Much less compute than pretraining. Focus is on data quality, not scale.',
          comparison: 'Pretraining: 10M+ GPU hours\nSFT: 1K-10K GPU hours\nRLHF: 10K-100K GPU hours\nDPO: 1K-10K GPU hours',
          efficiency: 'Often full fine-tune for SFT\nLoRA/QLoRA for efficiency\nParameter-efficient methods'
        },
        'metric-evals': {
          title: 'üìã EVALUATION',
          content: 'Post-training evals focus on helpfulness, harmlessness, and honesty (HHH).',
          benchmarks: 'MT-Bench: Multi-turn chat\nAlpacaEval: Instruction following\nTruthfulQA: Honesty\nBBQ: Bias\nHarmBench: Safety',
          human: 'Human preference ratings\nA/B testing\nRed-team evaluations'
        },

        // SFT Section
        'sft-concept': {
          title: 'üéì Supervised Fine-Tuning',
          content: 'Train on (instruction, response) pairs. Teaches the model to follow instructions and adopt assistant persona.',
          mechanism: 'Input: "Explain quantum computing"\nOutput: "Quantum computing uses..."\nLoss: Cross-entropy on response tokens',
          goal: 'Format: Learn chat structure\nStyle: Helpful assistant tone\nCapability: Follow instructions'
        },
        'sft-data': {
          title: 'üìù SFT Data Sources',
          content: 'High-quality instruction-response pairs from various sources.',
          sources: 'Human-written: Highest quality, expensive\nDistillation: From stronger models\nSynthetic: Model-generated, filtered\nOpen datasets: ShareGPT, FLAN, etc.',
          mix: 'Diverse tasks: QA, writing, coding, math\nMulti-turn conversations\nVarious difficulty levels'
        },
        'sft-format': {
          title: 'üí¨ Chat Format',
          content: 'Structure conversations with special tokens. Model learns to generate assistant turns.',
          format: '<|system|>You are a helpful assistant.<|end|>\n<|user|>Hello!<|end|>\n<|assistant|>Hi! How can I help?<|end|>',
          training: 'Loss only on assistant tokens\nMask user/system from loss\nTeach turn-taking'
        },
        'sft-loss': {
          title: 'üìâ SFT Loss',
          content: 'Standard cross-entropy, but only on response tokens. Instruction tokens are masked.',
          formula: 'L = -Œ£ log P(y_i | x, y_<i)\nOnly sum over response positions\nInstruction tokens: mask from loss',
          weighting: 'Some weight longer responses more\nOr weight by quality score\nBalance task types'
        },
        'sft-hyperparams': {
          title: '‚öôÔ∏è SFT Hyperparameters',
          content: 'Typically lower LR than pretraining. Few epochs to avoid overfitting.',
          typical: 'LR: 1e-5 to 5e-5\nEpochs: 1-3\nBatch: 32-128\nWarmup: 3-10%',
          caution: 'Too many epochs ‚Üí overfit\nToo high LR ‚Üí forget pretraining\nMonitor val loss closely'
        },

        // RLHF Section
        'rlhf-concept': {
          title: 'üéÆ RLHF Overview',
          content: 'Reinforcement Learning from Human Feedback. Train model to maximize human preference.',
          pipeline: '1. Collect comparisons (A vs B)\n2. Train reward model\n3. RL to maximize reward\n4. Iterate',
          goal: 'Align with human values\nReduce harmful outputs\nImprove helpfulness'
        },
        'rlhf-reward-data': {
          title: 'üìä Preference Data Collection',
          content: 'Humans compare two responses and pick the better one. Creates preference pairs.',
          process: 'Prompt ‚Üí Generate 2+ responses\nHuman ranks or compares\nRecord: (prompt, chosen, rejected)',
          scale: '100K+ comparisons typical\nDiverse prompts important\nQuality control essential'
        },
        'rlhf-reward-model': {
          title: 'üèÜ Reward Model Training',
          content: 'Train a model to predict human preferences. Becomes the reward signal for RL.',
          architecture: 'Same base model architecture\nLinear head ‚Üí scalar reward\nTrained on preference pairs',
          loss: 'Bradley-Terry: L = -log(œÉ(r_w - r_l))\nr_w = reward for chosen\nr_l = reward for rejected\nPush chosen > rejected'
        },
        'rlhf-reward-properties': {
          title: 'üìà Reward Model Properties',
          content: 'RM should generalize preferences, not memorize. Key quality metrics.',
          metrics: 'Accuracy on held-out pairs\nCalibration of scores\nGeneralization to new prompts',
          issues: 'Reward hacking: Find RM exploits\nOverfitting: Memorize pairs\nBias: Inherit annotator bias'
        },
        'rlhf-ppo': {
          title: 'üéØ PPO Training',
          content: 'Proximal Policy Optimization. Update policy to maximize reward while staying close to reference.',
          objective: 'max E[R(x,y) - Œ≤¬∑KL(œÄ||œÄ_ref)]\nR = reward model score\nKL = divergence from SFT model\nŒ≤ = KL penalty weight',
          mechanism: 'Generate response with policy\nScore with reward model\nUpdate policy toward high reward\nKL keeps policy stable'
        },
        'rlhf-kl': {
          title: '‚öñÔ∏è KL Divergence Penalty',
          content: 'Prevents policy from diverging too far from SFT model. Controls exploration vs stability.',
          formula: 'KL(œÄ||œÄ_ref) = Œ£ œÄ(y|x) log(œÄ(y|x)/œÄ_ref(y|x))\nPenalty: Œ≤ √ó KL',
          tuning: 'Œ≤ too low: Reward hacking\nŒ≤ too high: No learning\nTypical: 0.01 - 0.2',
          purpose: 'Maintain coherent language\nPrevent reward gaming\nStable training'
        },
        'rlhf-critic': {
          title: 'üìä Value Function (Critic)',
          content: 'Estimates expected future reward. Used for advantage estimation in PPO.',
          architecture: 'Share base with policy or separate\nLinear head ‚Üí value estimate\nTrained alongside policy',
          usage: 'Advantage = R - V(s)\nReduces variance\nBaseline subtraction'
        },
        'rlhf-challenges': {
          title: '‚ö†Ô∏è RLHF Challenges',
          content: 'RLHF is notoriously finicky. Many things can go wrong.',
          issues: 'Reward hacking: Exploit RM weaknesses\nMode collapse: Repetitive outputs\nKL explosion: Diverge from reference\nTraining instability: Sensitive to hyperparams',
          mitigations: 'Multiple reward models\nCareful KL tuning\nExtensive monitoring\nFrequent checkpointing'
        },

        // DPO Section
        'dpo-concept': {
          title: 'üéØ Direct Preference Optimization',
          content: 'Skip the reward model! Directly optimize policy on preference pairs. Simpler than RLHF.',
          insight: 'Optimal policy has closed form\nCan derive loss from preferences directly\nNo RL needed, just supervised learning',
          benefit: 'Simpler: No RM, no RL\nStable: Standard supervised training\nEffective: Competitive with RLHF'
        },
        'dpo-derivation': {
          title: 'üìê DPO Derivation',
          content: 'Mathematical insight: optimal RLHF policy implies a specific reward function.',
          math: 'r(x,y) = Œ≤ log(œÄ(y|x)/œÄ_ref(y|x)) + C\nSubstitute into Bradley-Terry loss\nGet DPO loss directly',
          intuition: 'Reward = how much policy prefers y over reference\nDPO directly increases this for chosen\nDecreases for rejected'
        },
        'dpo-loss': {
          title: 'üìâ DPO Loss Function',
          content: 'Binary cross-entropy on implicit reward difference. Elegant and simple.',
          formula: 'L = -log œÉ(Œ≤(log œÄ(y_w)/œÄ_ref(y_w) - log œÄ(y_l)/œÄ_ref(y_l)))\n\nSimplified:\nL = -log œÉ(Œ≤ √ó (Œî_chosen - Œî_rejected))\nŒî = log(œÄ/œÄ_ref)',
          implementation: 'Forward pass on chosen & rejected\nCompute log probs\nCompare to reference model\nSimple cross-entropy loss'
        },
        'dpo-reference': {
          title: 'üìå Reference Model',
          content: 'Frozen copy of SFT model. Anchors the optimization like KL penalty in RLHF.',
          role: 'Provides baseline log probs\nPrevents divergence\nSame role as œÄ_ref in RLHF',
          implementation: 'Load SFT model\nFreeze all parameters\nCompute log probs for chosen/rejected\nCompare with policy log probs'
        },
        'dpo-beta': {
          title: 'üéöÔ∏è Beta Parameter',
          content: 'Controls how much to trust preferences vs stay close to reference. Same role as KL coefficient.',
          tuning: 'Œ≤ = 0.1: Aggressive optimization\nŒ≤ = 0.5: Moderate\nŒ≤ = 1.0: Conservative',
          effect: 'Higher Œ≤: Stronger preference signal\nLower Œ≤: Closer to reference\nTypical: 0.1 - 0.5'
        },
        'dpo-advantages': {
          title: '‚úÖ DPO Advantages',
          content: 'Why DPO has become popular for alignment.',
          benefits: 'No reward model training\nNo RL instability\nStandard supervised training\nEasier to debug\nFaster iteration',
          results: 'Competitive with RLHF\nOften preferred for simplicity\nActive research area'
        },
        'dpo-variants': {
          title: 'üîÄ DPO Variants',
          content: 'Extensions and improvements to base DPO.',
          variants: 'IPO: Adds regularization\nKTO: Single response (no pairs)\ncDPO: Conservative update\nORPO: No reference model\nSimPO: Length normalization',
          research: 'Active area of research\nNew variants monthly\nTrade-offs vary by use case'
        },

        // Parameter Efficient Methods
        'peft-concept': {
          title: 'üí° Parameter-Efficient Fine-Tuning',
          content: 'Update only a small fraction of parameters. Enables fine-tuning on consumer hardware.',
          methods: 'LoRA: Low-rank adapters\nQLoRA: Quantized + LoRA\nPrefix tuning: Learnable prompts\nAdapters: Small MLP insertions',
          benefit: 'Memory: 10-100√ó reduction\nSpeed: Faster training\nStorage: Small checkpoint'
        },
        'peft-lora': {
          title: 'üîó LoRA',
          content: 'Low-Rank Adaptation. Add trainable low-rank matrices to frozen weights.',
          mechanism: 'W_new = W + BA\nW: Frozen original weights\nB: [d, r] learnable\nA: [r, d] learnable\nr << d (rank 8-64 typical)',
          math: 'Full fine-tune: d √ó d params\nLoRA: 2 √ó d √ó r params\nReduction: d/2r ‚âà 100-1000√ó'
        },
        'peft-qlora': {
          title: 'üóúÔ∏è QLoRA',
          content: 'Quantize base model to 4-bit, apply LoRA. Train 65B on single 48GB GPU.',
          mechanism: 'Base model: 4-bit quantized\nLoRA adapters: BF16\nOptimizer states: Only for adapters',
          efficiency: '70B in 4-bit: ~35GB\nLoRA params: ~100MB\nOptimizer: ~400MB\nTotal: <40GB'
        },

        // Safety & Evaluation
        'safety-redteam': {
          title: 'üî¥ Red Teaming',
          content: 'Adversarial testing to find model failures. Essential for safety.',
          process: 'Human testers try to elicit harmful outputs\nAutomatic red-teaming with other models\nCatalog failure modes',
          types: 'Jailbreaks: Bypass safety\nHarm elicitation: Dangerous content\nBias probing: Discrimination\nPrivacy: Data extraction'
        },
        'safety-constitutional': {
          title: 'üìú Constitutional AI',
          content: 'Anthropic\'s approach: Define principles, train model to follow them.',
          process: '1. Define constitution (principles)\n2. Model critiques own outputs\n3. Revises based on principles\n4. Train on revisions',
          benefit: 'Scalable: Less human labeling\nPrincipled: Explicit values\nIterative: Self-improvement'
        },
        'safety-guardrails': {
          title: 'üõ°Ô∏è Guardrails',
          content: 'Additional safety layers beyond training. Runtime protections.',
          types: 'Input filters: Block harmful prompts\nOutput filters: Check responses\nClassifiers: Detect categories\nRule-based: Keyword blocking',
          deployment: 'Defense in depth\nMultiple layers\nMonitoring & logging'
        },

        // Evaluation
        'eval-mtbench': {
          title: 'üìä MT-Bench',
          content: 'Multi-turn benchmark for chat models. Tests conversation ability.',
          structure: '80 high-quality questions\n8 categories (writing, reasoning, etc.)\nMulti-turn follow-ups\nGPT-4 as judge',
          scoring: '1-10 scale per turn\nAverage across categories\nStrong models: 8+/10'
        },
        'eval-alpaca': {
          title: 'ü¶ô AlpacaEval',
          content: 'Instruction-following benchmark. Compares to reference model.',
          mechanism: '805 instructions\nGenerate responses\nGPT-4 compares to reference\nWin rate reported',
          metrics: 'Win rate vs reference\nLength-controlled version\nCorrelates with human preference'
        },
        'eval-human': {
          title: 'üë• Human Evaluation',
          content: 'Gold standard for alignment. Real humans judge model outputs.',
          methods: 'A/B testing: Pick preferred\nLikert scales: Rate 1-5\nQualitative: Open feedback',
          challenges: 'Expensive: Human time\nVariability: Annotator disagreement\nBias: Various cognitive biases'
        },

        // Training Infrastructure
        'infra-full': {
          title: 'üîß Full Fine-Tuning',
          content: 'Update all parameters. Highest quality but most expensive.',
          requirements: 'Same infra as pretraining\nFull model in memory\nFull optimizer states',
          when: 'Maximum quality needed\nSufficient compute available\nSignificant distribution shift'
        },
        'infra-efficient': {
          title: '‚ö° Efficient Training',
          content: 'LoRA/QLoRA for resource-constrained settings. Most common in practice.',
          setup: 'Single GPU: QLoRA\nMulti-GPU: LoRA + FSDP\nCloud: Spot instances',
          tradeoff: 'Slight quality loss vs full\nMassive cost savings\nFaster iteration'
        },
      };

      const Tooltip = () => {
        if (!tooltip || !tooltips[tooltip]) return null;
        const t = tooltips[tooltip];
        
        
        return (
          <div 
            className="fixed z-50 w-[400px] p-5 bg-slate-900 border-2 border-white/20 rounded-xl shadow-2xl"
            style={{ right: 20, bottom: 20 }}
          >
            <div className="text-lg font-black text-white mb-2">{t.title}</div>
            <p className="text-slate-300 text-sm leading-relaxed mb-3">{t.content}</p>
            {t.formula && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">FORMULA</div>
                <pre className="text-xs text-cyan-300 font-mono whitespace-pre-wrap">{t.formula}</pre>
              </div>
            )}
            {t.mechanism && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">MECHANISM</div>
                <pre className="text-xs text-green-300 font-mono whitespace-pre-wrap">{t.mechanism}</pre>
              </div>
            )}
            {t.stages && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">STAGES</div>
                <pre className="text-xs text-purple-300 font-mono whitespace-pre-wrap">{t.stages}</pre>
              </div>
            )}
            {t.pipeline && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">PIPELINE</div>
                <pre className="text-xs text-orange-300 font-mono whitespace-pre-wrap">{t.pipeline}</pre>
              </div>
            )}
            {t.benefits && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">BENEFITS</div>
                <pre className="text-xs text-green-300 font-mono whitespace-pre-wrap">{t.benefits}</pre>
              </div>
            )}
            {t.issues && (
              <div className="bg-black/50 rounded-lg p-3 mb-3">
                <div className="text-xs text-slate-500 font-bold mb-1">CHALLENGES</div>
                <pre className="text-xs text-red-300 font-mono whitespace-pre-wrap">{t.issues}</pre>
              </div>
            )}
            {t.benefit && (
              <div className="text-xs text-green-400">
                <span className="font-bold">‚úÖ </span>{t.benefit}
              </div>
            )}
            {t.goal && (
              <div className="text-xs text-blue-400 mt-2">
                <span className="font-bold">üéØ Goal: </span>{t.goal}
              </div>
            )}
          </div>
        );
      };

      const Hoverable = ({ id, children }) => (
        <div 
          data-tooltip-id={id}
          
          className="cursor-pointer transition-all hover:scale-[1.02] hover:brightness-110"
        >
          {children}
        </div>
      );

      return (
        <div className="min-h-screen bg-black text-white p-8" onMouseMove={handleMouseMove}>
          <Tooltip />
          
          {/* Background */}
          <div className="fixed inset-0 pointer-events-none overflow-hidden">
            <div className="absolute w-[800px] h-[800px] -top-96 left-1/4 bg-pink-500/10 rounded-full blur-3xl" />
            <div className="absolute w-[600px] h-[600px] top-1/2 right-0 bg-purple-500/10 rounded-full blur-3xl" />
            <div className="absolute w-[600px] h-[600px] bottom-0 left-0 bg-rose-500/10 rounded-full blur-3xl" />
          </div>

          <div className="relative max-w-7xl mx-auto">
            {/* Header */}
            <header className="text-center mb-12">
              <div className="inline-flex items-center gap-2 px-6 py-2 bg-pink-600/30 border border-pink-400 rounded-full mb-6">
                <span className="text-pink-300 font-bold">POST-TRAINING</span>
                <span className="text-white">‚Ä¢</span>
                <span className="text-pink-200 font-medium">Hover over any item for details</span>
              </div>
              <h1 className="text-5xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-pink-400 via-purple-400 to-rose-400">
                SFT, RLHF & DPO
              </h1>
              <p className="text-xl text-slate-200 max-w-3xl mx-auto leading-relaxed">
                <span className="text-pink-300 font-bold">From base model to aligned assistant</span> ‚Äî the alignment training pipeline.
                <span className="text-purple-300 ml-2">üñ±Ô∏è Hover for detailed tooltips.</span>
              </p>
            </header>

            {/* Key Metrics */}
            <div className="grid grid-cols-4 gap-4 mb-12">
              <Hoverable id="metric-stages">
                <div className="p-5 rounded-xl bg-pink-600/90 border-2 border-pink-400 shadow-lg shadow-pink-500/20">
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-3xl">üìä</span>
                    <span className="text-sm font-black text-white/90 tracking-wider">STAGES</span>
                  </div>
                  <div className="text-2xl font-black text-pink-100">SFT‚ÜíRLHF</div>
                  <div className="text-sm text-white/80 font-medium mt-1">Or SFT‚ÜíDPO</div>
                </div>
              </Hoverable>
              
              <Hoverable id="metric-data">
                <div className="p-5 rounded-xl bg-purple-600/90 border-2 border-purple-400 shadow-lg shadow-purple-500/20">
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-3xl">üìù</span>
                    <span className="text-sm font-black text-white/90 tracking-wider">DATA</span>
                  </div>
                  <div className="text-2xl font-black text-purple-100">10K-1M</div>
                  <div className="text-sm text-white/80 font-medium mt-1">High-quality examples</div>
                </div>
              </Hoverable>
              
              <Hoverable id="metric-compute">
                <div className="p-5 rounded-xl bg-violet-600/90 border-2 border-violet-400 shadow-lg shadow-violet-500/20">
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-3xl">‚ö°</span>
                    <span className="text-sm font-black text-white/90 tracking-wider">COMPUTE</span>
                  </div>
                  <div className="text-2xl font-black text-violet-100">~1%</div>
                  <div className="text-sm text-white/80 font-medium mt-1">Of pretraining</div>
                </div>
              </Hoverable>
              
              <Hoverable id="metric-evals">
                <div className="p-5 rounded-xl bg-rose-600/90 border-2 border-rose-400 shadow-lg shadow-rose-500/20">
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-3xl">üìã</span>
                    <span className="text-sm font-black text-white/90 tracking-wider">EVALS</span>
                  </div>
                  <div className="text-2xl font-black text-rose-100">HHH</div>
                  <div className="text-sm text-white/80 font-medium mt-1">Helpful, Harmless, Honest</div>
                </div>
              </Hoverable>
            </div>

            {/* Pipeline Overview */}
            <div className="bg-slate-900/80 border-2 border-pink-500/50 rounded-xl p-6 mb-10">
              <div className="text-lg font-black text-pink-300 mb-4 text-center">üîÑ POST-TRAINING PIPELINE</div>
              <div className="flex items-center justify-between gap-4">
                <div className="bg-slate-800 rounded-xl p-4 text-center flex-1">
                  <div className="text-2xl mb-2">üß†</div>
                  <div className="text-slate-300 font-bold">Base Model</div>
                  <div className="text-slate-500 text-xs">Pretrained LLM</div>
                </div>
                <div className="text-pink-400 text-2xl">‚Üí</div>
                <div className="bg-blue-900/50 border-2 border-blue-400 rounded-xl p-4 text-center flex-1">
                  <div className="text-2xl mb-2">üéì</div>
                  <div className="text-blue-200 font-bold">SFT</div>
                  <div className="text-blue-300/60 text-xs">Learn instructions</div>
                </div>
                <div className="text-pink-400 text-2xl">‚Üí</div>
                <div className="bg-purple-900/50 border-2 border-purple-400 rounded-xl p-4 text-center flex-1">
                  <div className="text-2xl mb-2">üéÆ</div>
                  <div className="text-purple-200 font-bold">RLHF</div>
                  <div className="text-purple-300/60 text-xs">Human preferences</div>
                </div>
                <div className="text-slate-500 text-lg px-2">or</div>
                <div className="bg-green-900/50 border-2 border-green-400 rounded-xl p-4 text-center flex-1">
                  <div className="text-2xl mb-2">üéØ</div>
                  <div className="text-green-200 font-bold">DPO</div>
                  <div className="text-green-300/60 text-xs">Direct optimization</div>
                </div>
                <div className="text-pink-400 text-2xl">‚Üí</div>
                <div className="bg-gradient-to-br from-pink-800 to-purple-800 border-2 border-pink-400 rounded-xl p-4 text-center flex-1">
                  <div className="text-2xl mb-2">‚ú®</div>
                  <div className="text-pink-100 font-bold">Assistant</div>
                  <div className="text-pink-200/60 text-xs">Aligned model</div>
                </div>
              </div>
            </div>

            {/* SECTION 1: SFT */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-blue-500/50">
                  1
                </div>
                <div>
                  <h2 className="text-3xl font-black text-blue-300">SUPERVISED FINE-TUNING (SFT)</h2>
                  <p className="text-blue-200/80">Teach the model to follow instructions</p>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-6 mb-6">
                {/* Concept & Data */}
                <div className="space-y-4">
                  <Hoverable id="sft-concept">
                    <div className="p-4 rounded-xl bg-blue-900/50 border-2 border-blue-400">
                      <div className="text-xl font-black text-blue-200 mb-2">üéì SFT Concept</div>
                      <div className="text-blue-100/80 text-sm">Train on (instruction, response) pairs</div>
                      <div className="text-blue-100/60 text-xs mt-2">Standard supervised learning</div>
                    </div>
                  </Hoverable>

                  <Hoverable id="sft-data">
                    <div className="p-4 rounded-xl bg-cyan-900/50 border-2 border-cyan-400">
                      <div className="text-xl font-black text-cyan-200 mb-2">üìù Data Sources</div>
                      <div className="text-cyan-100/80 text-sm">Human-written, distilled, synthetic</div>
                      <div className="text-cyan-100/60 text-xs mt-2">Quality over quantity</div>
                    </div>
                  </Hoverable>
                </div>

                {/* Format & Loss */}
                <div className="space-y-4">
                  <Hoverable id="sft-format">
                    <div className="p-4 rounded-xl bg-sky-900/50 border-2 border-sky-400">
                      <div className="text-xl font-black text-sky-200 mb-2">üí¨ Chat Format</div>
                      <div className="text-sky-100/80 text-sm">Special tokens for turns</div>
                      <div className="text-sky-100/60 text-xs mt-2">&lt;user&gt; &lt;assistant&gt; &lt;system&gt;</div>
                    </div>
                  </Hoverable>

                  <Hoverable id="sft-loss">
                    <div className="p-4 rounded-xl bg-indigo-900/50 border-2 border-indigo-400">
                      <div className="text-xl font-black text-indigo-200 mb-2">üìâ Loss Function</div>
                      <div className="text-indigo-100/80 text-sm">Cross-entropy on response only</div>
                      <div className="text-indigo-100/60 text-xs mt-2">Mask instruction tokens</div>
                    </div>
                  </Hoverable>
                </div>
              </div>

              <Hoverable id="sft-hyperparams">
                <div className="bg-slate-900/80 border border-blue-500/30 rounded-xl p-4">
                  <div className="text-blue-300 font-bold mb-2">‚öôÔ∏è Typical SFT Hyperparameters</div>
                  <div className="grid grid-cols-4 gap-4 text-sm">
                    <div className="bg-slate-800 rounded-lg p-2 text-center">
                      <div className="text-blue-300 font-bold">LR</div>
                      <div className="text-slate-400">1e-5 to 5e-5</div>
                    </div>
                    <div className="bg-slate-800 rounded-lg p-2 text-center">
                      <div className="text-blue-300 font-bold">Epochs</div>
                      <div className="text-slate-400">1-3</div>
                    </div>
                    <div className="bg-slate-800 rounded-lg p-2 text-center">
                      <div className="text-blue-300 font-bold">Batch</div>
                      <div className="text-slate-400">32-128</div>
                    </div>
                    <div className="bg-slate-800 rounded-lg p-2 text-center">
                      <div className="text-blue-300 font-bold">Warmup</div>
                      <div className="text-slate-400">3-10%</div>
                    </div>
                  </div>
                </div>
              </Hoverable>
            </section>

            {/* Flow Arrow */}
            <div className="flex justify-center my-6">
              <div className="w-1 h-10 bg-gradient-to-b from-blue-400 to-purple-400 rounded-full" />
            </div>

            {/* SECTION 2: RLHF */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-purple-500/50">
                  2
                </div>
                <div>
                  <h2 className="text-3xl font-black text-purple-300">RLHF: REINFORCEMENT LEARNING FROM HUMAN FEEDBACK</h2>
                  <p className="text-purple-200/80">Train model to maximize human preference</p>
                </div>
              </div>

              {/* RLHF Pipeline */}
              <Hoverable id="rlhf-concept">
                <div className="bg-purple-900/30 border-2 border-purple-500 rounded-xl p-4 mb-6">
                  <div className="text-purple-200 font-bold mb-3">üéÆ RLHF Pipeline</div>
                  <div className="flex items-center justify-between gap-2">
                    <div className="bg-slate-800 rounded-lg p-3 text-center flex-1">
                      <div className="text-purple-300 font-bold text-sm">1. Collect</div>
                      <div className="text-slate-400 text-xs">Human comparisons</div>
                    </div>
                    <div className="text-purple-400">‚Üí</div>
                    <div className="bg-slate-800 rounded-lg p-3 text-center flex-1">
                      <div className="text-purple-300 font-bold text-sm">2. Train RM</div>
                      <div className="text-slate-400 text-xs">Reward model</div>
                    </div>
                    <div className="text-purple-400">‚Üí</div>
                    <div className="bg-slate-800 rounded-lg p-3 text-center flex-1">
                      <div className="text-purple-300 font-bold text-sm">3. PPO</div>
                      <div className="text-slate-400 text-xs">RL training</div>
                    </div>
                    <div className="text-purple-400">‚Üí</div>
                    <div className="bg-slate-800 rounded-lg p-3 text-center flex-1">
                      <div className="text-purple-300 font-bold text-sm">4. Iterate</div>
                      <div className="text-slate-400 text-xs">Repeat</div>
                    </div>
                  </div>
                </div>
              </Hoverable>

              <div className="grid grid-cols-2 gap-6 mb-6">
                {/* Reward Model */}
                <div className="bg-slate-900/80 border border-purple-500/30 rounded-xl p-5">
                  <div className="text-lg font-black text-purple-300 mb-4">üèÜ Reward Model</div>
                  <div className="space-y-3">
                    <Hoverable id="rlhf-reward-data">
                      <div className="bg-purple-900/40 border border-purple-400 rounded-lg p-3">
                        <div className="text-purple-200 font-bold text-sm">üìä Preference Data</div>
                        <div className="text-purple-100/60 text-xs">Human picks A vs B</div>
                      </div>
                    </Hoverable>
                    <Hoverable id="rlhf-reward-model">
                      <div className="bg-violet-900/40 border border-violet-400 rounded-lg p-3">
                        <div className="text-violet-200 font-bold text-sm">üß† RM Training</div>
                        <div className="text-violet-100/60 text-xs">Bradley-Terry loss</div>
                      </div>
                    </Hoverable>
                    <Hoverable id="rlhf-reward-properties">
                      <div className="bg-indigo-900/40 border border-indigo-400 rounded-lg p-3">
                        <div className="text-indigo-200 font-bold text-sm">üìà Properties</div>
                        <div className="text-indigo-100/60 text-xs">Generalization, calibration</div>
                      </div>
                    </Hoverable>
                  </div>
                </div>

                {/* PPO */}
                <div className="bg-slate-900/80 border border-purple-500/30 rounded-xl p-5">
                  <div className="text-lg font-black text-purple-300 mb-4">üéØ PPO Training</div>
                  <div className="space-y-3">
                    <Hoverable id="rlhf-ppo">
                      <div className="bg-orange-900/40 border border-orange-400 rounded-lg p-3">
                        <div className="text-orange-200 font-bold text-sm">üéØ PPO Objective</div>
                        <div className="text-orange-100/60 text-xs">max R - Œ≤¬∑KL</div>
                      </div>
                    </Hoverable>
                    <Hoverable id="rlhf-kl">
                      <div className="bg-yellow-900/40 border border-yellow-400 rounded-lg p-3">
                        <div className="text-yellow-200 font-bold text-sm">‚öñÔ∏è KL Penalty</div>
                        <div className="text-yellow-100/60 text-xs">Stay close to SFT</div>
                      </div>
                    </Hoverable>
                    <Hoverable id="rlhf-critic">
                      <div className="bg-amber-900/40 border border-amber-400 rounded-lg p-3">
                        <div className="text-amber-200 font-bold text-sm">üìä Value Function</div>
                        <div className="text-amber-100/60 text-xs">Advantage estimation</div>
                      </div>
                    </Hoverable>
                  </div>
                </div>
              </div>

              <Hoverable id="rlhf-challenges">
                <div className="bg-red-900/30 border border-red-500/50 rounded-xl p-4">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">‚ö†Ô∏è</span>
                    <div>
                      <div className="text-red-300 font-bold">RLHF Challenges</div>
                      <div className="text-red-100/70 text-sm">Reward hacking, mode collapse, KL explosion, training instability</div>
                    </div>
                  </div>
                </div>
              </Hoverable>
            </section>

            {/* Flow Arrow */}
            <div className="flex justify-center my-6">
              <div className="w-1 h-10 bg-gradient-to-b from-purple-400 to-green-400 rounded-full" />
            </div>

            {/* SECTION 3: DPO */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-green-500/50">
                  3
                </div>
                <div>
                  <h2 className="text-3xl font-black text-green-300">DPO: DIRECT PREFERENCE OPTIMIZATION</h2>
                  <p className="text-green-200/80">Skip the reward model ‚Äî simpler and stable</p>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-6 mb-6">
                {/* DPO Concept */}
                <div className="space-y-4">
                  <Hoverable id="dpo-concept">
                    <div className="p-4 rounded-xl bg-green-900/50 border-2 border-green-400">
                      <div className="text-xl font-black text-green-200 mb-2">üéØ DPO Concept</div>
                      <div className="text-green-100/80 text-sm">Directly optimize on preference pairs</div>
                      <div className="text-green-100/60 text-xs mt-2">No reward model, no RL</div>
                    </div>
                  </Hoverable>

                  <Hoverable id="dpo-derivation">
                    <div className="p-4 rounded-xl bg-emerald-900/50 border-2 border-emerald-400">
                      <div className="text-xl font-black text-emerald-200 mb-2">üìê Derivation</div>
                      <div className="text-emerald-100/80 text-sm">Optimal policy ‚Üí closed-form reward</div>
                      <div className="text-emerald-100/60 text-xs mt-2">Mathematical insight</div>
                    </div>
                  </Hoverable>

                  <Hoverable id="dpo-reference">
                    <div className="p-4 rounded-xl bg-teal-900/50 border-2 border-teal-400">
                      <div className="text-xl font-black text-teal-200 mb-2">üìå Reference Model</div>
                      <div className="text-teal-100/80 text-sm">Frozen SFT model</div>
                      <div className="text-teal-100/60 text-xs mt-2">Anchors optimization</div>
                    </div>
                  </Hoverable>
                </div>

                {/* DPO Loss & Tuning */}
                <div className="space-y-4">
                  <Hoverable id="dpo-loss">
                    <div className="p-4 rounded-xl bg-lime-900/50 border-2 border-lime-400">
                      <div className="text-xl font-black text-lime-200 mb-2">üìâ DPO Loss</div>
                      <div className="text-lime-100/80 text-sm font-mono text-xs">L = -log œÉ(Œ≤¬∑(Œîw - Œîl))</div>
                      <div className="text-lime-100/60 text-xs mt-2">Simple cross-entropy style</div>
                    </div>
                  </Hoverable>

                  <Hoverable id="dpo-beta">
                    <div className="p-4 rounded-xl bg-cyan-900/50 border-2 border-cyan-400">
                      <div className="text-xl font-black text-cyan-200 mb-2">üéöÔ∏è Beta Parameter</div>
                      <div className="text-cyan-100/80 text-sm">Controls optimization strength</div>
                      <div className="text-cyan-100/60 text-xs mt-2">Œ≤ = 0.1 - 0.5 typical</div>
                    </div>
                  </Hoverable>

                  <Hoverable id="dpo-variants">
                    <div className="p-4 rounded-xl bg-sky-900/50 border-2 border-sky-400">
                      <div className="text-xl font-black text-sky-200 mb-2">üîÄ Variants</div>
                      <div className="text-sky-100/80 text-sm">IPO, KTO, cDPO, ORPO, SimPO</div>
                      <div className="text-sky-100/60 text-xs mt-2">Active research area</div>
                    </div>
                  </Hoverable>
                </div>
              </div>

              <Hoverable id="dpo-advantages">
                <div className="bg-green-900/30 border-2 border-green-500 rounded-xl p-4">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">‚úÖ</span>
                    <div>
                      <div className="text-green-300 font-bold">DPO Advantages</div>
                      <div className="text-green-100/70 text-sm">No RM training, no RL instability, standard supervised training, easier to debug, faster iteration</div>
                    </div>
                  </div>
                </div>
              </Hoverable>
            </section>

            {/* Flow Arrow */}
            <div className="flex justify-center my-6">
              <div className="w-1 h-10 bg-gradient-to-b from-green-400 to-yellow-400 rounded-full" />
            </div>

            {/* SECTION 4: PEFT */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-yellow-500/50">
                  4
                </div>
                <div>
                  <h2 className="text-3xl font-black text-yellow-300">PARAMETER-EFFICIENT METHODS</h2>
                  <p className="text-yellow-200/80">LoRA, QLoRA ‚Äî fine-tune with minimal resources</p>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <Hoverable id="peft-concept">
                  <div className="p-4 rounded-xl bg-yellow-900/50 border-2 border-yellow-400">
                    <div className="text-xl font-black text-yellow-200 mb-2">üí° PEFT Concept</div>
                    <div className="text-yellow-100/80 text-sm">Update small fraction of params</div>
                    <div className="text-yellow-100/60 text-xs mt-2">10-100√ó memory reduction</div>
                  </div>
                </Hoverable>

                <Hoverable id="peft-lora">
                  <div className="p-4 rounded-xl bg-orange-900/50 border-2 border-orange-400">
                    <div className="text-xl font-black text-orange-200 mb-2">üîó LoRA</div>
                    <div className="text-orange-100/80 text-sm">W_new = W + BA</div>
                    <div className="text-orange-100/60 text-xs mt-2">Low-rank adapters</div>
                  </div>
                </Hoverable>

                <Hoverable id="peft-qlora">
                  <div className="p-4 rounded-xl bg-amber-900/50 border-2 border-amber-400">
                    <div className="text-xl font-black text-amber-200 mb-2">üóúÔ∏è QLoRA</div>
                    <div className="text-amber-100/80 text-sm">4-bit base + LoRA</div>
                    <div className="text-amber-100/60 text-xs mt-2">70B on single GPU</div>
                  </div>
                </Hoverable>
              </div>
              
              {/* Training Infrastructure */}
              <div className="grid grid-cols-2 gap-4 mt-4">
                <Hoverable id="infra-full">
                  <div className="p-4 rounded-xl bg-slate-800/50 border-2 border-slate-500">
                    <div className="text-xl font-black text-slate-200 mb-2">üîß Full Fine-Tuning</div>
                    <div className="text-slate-100/80 text-sm">Update all parameters</div>
                    <div className="text-slate-100/60 text-xs mt-2">Highest quality ‚Ä¢ Most expensive</div>
                  </div>
                </Hoverable>
                
                <Hoverable id="infra-efficient">
                  <div className="p-4 rounded-xl bg-emerald-900/50 border-2 border-emerald-400">
                    <div className="text-xl font-black text-emerald-200 mb-2">‚ö° Efficient Training</div>
                    <div className="text-emerald-100/80 text-sm">LoRA/QLoRA for constrained settings</div>
                    <div className="text-emerald-100/60 text-xs mt-2">Cost savings ‚Ä¢ Faster iteration</div>
                  </div>
                </Hoverable>
              </div>
            </section>

            {/* SECTION 5: SAFETY & EVALUATION */}
            <section className="mb-10">
              <div className="flex items-center gap-4 mb-6">
                <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-red-500 to-rose-600 flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-red-500/50">
                  5
                </div>
                <div>
                  <h2 className="text-3xl font-black text-red-300">SAFETY & EVALUATION</h2>
                  <p className="text-red-200/80">Red-teaming, guardrails, and benchmarks</p>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-6">
                {/* Safety */}
                <div className="bg-slate-900/80 border border-red-500/30 rounded-xl p-5">
                  <div className="text-lg font-black text-red-300 mb-4">üõ°Ô∏è Safety</div>
                  <div className="space-y-3">
                    <Hoverable id="safety-redteam">
                      <div className="bg-red-900/40 border border-red-400 rounded-lg p-3">
                        <div className="text-red-200 font-bold text-sm">üî¥ Red Teaming</div>
                        <div className="text-red-100/60 text-xs">Adversarial testing</div>
                      </div>
                    </Hoverable>
                    <Hoverable id="safety-constitutional">
                      <div className="bg-rose-900/40 border border-rose-400 rounded-lg p-3">
                        <div className="text-rose-200 font-bold text-sm">üìú Constitutional AI</div>
                        <div className="text-rose-100/60 text-xs">Principle-based training</div>
                      </div>
                    </Hoverable>
                    <Hoverable id="safety-guardrails">
                      <div className="bg-pink-900/40 border border-pink-400 rounded-lg p-3">
                        <div className="text-pink-200 font-bold text-sm">üõ°Ô∏è Guardrails</div>
                        <div className="text-pink-100/60 text-xs">Runtime protections</div>
                      </div>
                    </Hoverable>
                  </div>
                </div>

                {/* Evaluation */}
                <div className="bg-slate-900/80 border border-red-500/30 rounded-xl p-5">
                  <div className="text-lg font-black text-red-300 mb-4">üìã Evaluation</div>
                  <div className="space-y-3">
                    <Hoverable id="eval-mtbench">
                      <div className="bg-purple-900/40 border border-purple-400 rounded-lg p-3">
                        <div className="text-purple-200 font-bold text-sm">üìä MT-Bench</div>
                        <div className="text-purple-100/60 text-xs">Multi-turn chat eval</div>
                      </div>
                    </Hoverable>
                    <Hoverable id="eval-alpaca">
                      <div className="bg-violet-900/40 border border-violet-400 rounded-lg p-3">
                        <div className="text-violet-200 font-bold text-sm">ü¶ô AlpacaEval</div>
                        <div className="text-violet-100/60 text-xs">Instruction following</div>
                      </div>
                    </Hoverable>
                    <Hoverable id="eval-human">
                      <div className="bg-indigo-900/40 border border-indigo-400 rounded-lg p-3">
                        <div className="text-indigo-200 font-bold text-sm">üë• Human Eval</div>
                        <div className="text-indigo-100/60 text-xs">Gold standard</div>
                      </div>
                    </Hoverable>
                  </div>
                </div>
              </div>
            </section>

            {/* Summary Box */}
            <div className="bg-gradient-to-r from-pink-900/50 to-purple-900/50 border-2 border-pink-400/50 rounded-xl p-8 text-center">
              <div className="text-2xl font-black text-white mb-4">
                üéâ POST-TRAINING COMPLETE
              </div>
              <div className="text-slate-300 max-w-3xl mx-auto mb-6">
                From base model to aligned assistant: SFT teaches format, RLHF/DPO aligns preferences, safety ensures responsible deployment.
              </div>
              
              {/* Comparison */}
              <div className="grid grid-cols-2 gap-4 mt-6 max-w-2xl mx-auto">
                <div className="bg-purple-900/50 border border-purple-400 rounded-lg p-4">
                  <div className="text-purple-300 font-bold">RLHF Path</div>
                  <div className="text-purple-100/70 text-sm mt-1">SFT ‚Üí RM ‚Üí PPO</div>
                  <div className="text-purple-100/50 text-xs mt-1">Complex but proven</div>
                </div>
                <div className="bg-green-900/50 border border-green-400 rounded-lg p-4">
                  <div className="text-green-300 font-bold">DPO Path</div>
                  <div className="text-green-100/70 text-sm mt-1">SFT ‚Üí DPO</div>
                  <div className="text-green-100/50 text-xs mt-1">Simple and effective</div>
                </div>
              </div>
            </div>

            {/* Footer */}
            <footer className="mt-12 text-center text-slate-500 text-sm">
              <p>Post-Training: SFT, RLHF & DPO ‚Ä¢ End-to-End Training Lifecycle</p>
              <p className="text-xs mt-1 text-slate-600">Base Model ‚Üí SFT ‚Üí Preference Alignment ‚Üí Aligned Assistant</p>
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PostTrainingStage />);
  </script>
</body>
</html>
